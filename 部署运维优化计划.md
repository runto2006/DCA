# SOLBTC-DCAç³»ç»Ÿéƒ¨ç½²è¿ç»´ä¼˜åŒ–è®¡åˆ’

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### 1. éƒ¨ç½²è‡ªåŠ¨åŒ–
- **ç›®æ ‡**: å®ç°ä¸€é”®éƒ¨ç½²å’Œå›æ»š
- **å½“å‰çŠ¶æ€**: æ‰‹åŠ¨éƒ¨ç½²
- **ä¼˜åŒ–æªæ–½**:
  - CI/CDæµæ°´çº¿å»ºè®¾
  - è‡ªåŠ¨åŒ–æµ‹è¯•é›†æˆ
  - ç¯å¢ƒç®¡ç†ä¼˜åŒ–
  - ç›‘æ§å‘Šè­¦ç³»ç»Ÿ

### 2. æ€§èƒ½ç›‘æ§
- **ç›®æ ‡**: å…¨é¢ç›‘æ§ç³»ç»Ÿæ€§èƒ½
- **å½“å‰çŠ¶æ€**: åŸºç¡€æ—¥å¿—
- **ä¼˜åŒ–æªæ–½**:
  - åº”ç”¨æ€§èƒ½ç›‘æ§(APM)
  - æ•°æ®åº“æ€§èƒ½ç›‘æ§
  - ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
  - å‘Šè­¦æœºåˆ¶å®Œå–„

### 3. å®‰å…¨åŠ å›º
- **ç›®æ ‡**: æå‡ç³»ç»Ÿå®‰å…¨æ€§
- **å½“å‰çŠ¶æ€**: åŸºç¡€å®‰å…¨
- **ä¼˜åŒ–æªæ–½**:
  - APIå®‰å…¨åŠ å›º
  - æ•°æ®åŠ å¯†
  - è®¿é—®æ§åˆ¶
  - å®‰å…¨å®¡è®¡

## ğŸ“‹ å…·ä½“å®æ–½è®¡åˆ’

### é˜¶æ®µ1: éƒ¨ç½²è‡ªåŠ¨åŒ– (3-4å¤©)

#### 1.1 GitHub Actions CI/CDæµæ°´çº¿
```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Run linting
        run: npm run lint
      
      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          BINANCE_SECRET_KEY: ${{ secrets.BINANCE_SECRET_KEY }}

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
```

#### 1.2 Dockerå®¹å™¨åŒ–
```dockerfile
# Dockerfile
FROM node:18-alpine AS base

# Install dependencies only when needed
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Install dependencies based on the preferred package manager
COPY package.json package-lock.json* ./
RUN npm ci --only=production

# Rebuild the source code only when needed
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Next.js collects completely anonymous telemetry data about general usage.
# Learn more here: https://nextjs.org/telemetry
# Uncomment the following line in case you want to disable telemetry during the build.
ENV NEXT_TELEMETRY_DISABLED 1

RUN npm run build

# Production image, copy all the files and run next
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public

# Set the correct permission for prerender cache
RUN mkdir .next
RUN chown nextjs:nodejs .next

# Automatically leverage output traces to reduce image size
# https://nextjs.org/docs/advanced-features/output-file-tracing
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
```

#### 1.3 ç¯å¢ƒç®¡ç†
```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_SECRET_KEY=${BINANCE_SECRET_KEY}
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=solbtc_dca
      - POSTGRES_USER=solbtc_user
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
```

### é˜¶æ®µ2: æ€§èƒ½ç›‘æ§ (4-5å¤©)

#### 2.1 åº”ç”¨æ€§èƒ½ç›‘æ§(APM)
```typescript
// lib/monitoring/apm.ts
import { performance } from 'perf_hooks'

export class APMMonitor {
  private metrics: Map<string, number[]> = new Map()
  
  startTimer(operation: string): () => void {
    const start = performance.now()
    
    return () => {
      const duration = performance.now() - start
      this.recordMetric(operation, duration)
    }
  }
  
  recordMetric(name: string, value: number) {
    if (!this.metrics.has(name)) {
      this.metrics.set(name, [])
    }
    this.metrics.get(name)!.push(value)
    
    // ä¿æŒæœ€è¿‘1000ä¸ªæ•°æ®ç‚¹
    if (this.metrics.get(name)!.length > 1000) {
      this.metrics.get(name)!.shift()
    }
  }
  
  getMetrics(name: string) {
    const values = this.metrics.get(name) || []
    if (values.length === 0) return null
    
    const sorted = [...values].sort((a, b) => a - b)
    return {
      count: values.length,
      avg: values.reduce((sum, v) => sum + v, 0) / values.length,
      min: sorted[0],
      max: sorted[sorted.length - 1],
      p95: sorted[Math.floor(sorted.length * 0.95)],
      p99: sorted[Math.floor(sorted.length * 0.99)]
    }
  }
  
  async exportMetrics(): Promise<any> {
    const result: any = {}
    for (const [name, values] of this.metrics) {
      result[name] = this.getMetrics(name)
    }
    return result
  }
}

export const apm = new APMMonitor()
```

#### 2.2 æ•°æ®åº“æ€§èƒ½ç›‘æ§
```typescript
// lib/monitoring/database-monitor.ts
import { query } from '@/lib/database'

export class DatabaseMonitor {
  async getConnectionStats() {
    const result = await query(`
      SELECT 
        count(*) as active_connections,
        max_conn as max_connections,
        (count(*)::float / max_conn::float * 100) as connection_usage_percent
      FROM pg_stat_activity, 
           (SELECT setting::int as max_conn FROM pg_settings WHERE name = 'max_connections') as max_conn
    `)
    
    return result.rows[0]
  }
  
  async getSlowQueries() {
    const result = await query(`
      SELECT 
        query,
        calls,
        total_time,
        mean_time,
        rows
      FROM pg_stat_statements 
      ORDER BY mean_time DESC 
      LIMIT 10
    `)
    
    return result.rows
  }
  
  async getTableStats() {
    const result = await query(`
      SELECT 
        schemaname,
        tablename,
        n_tup_ins as inserts,
        n_tup_upd as updates,
        n_tup_del as deletes,
        n_live_tup as live_rows,
        n_dead_tup as dead_rows
      FROM pg_stat_user_tables
      ORDER BY n_live_tup DESC
    `)
    
    return result.rows
  }
}

export const dbMonitor = new DatabaseMonitor()
```

#### 2.3 ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
```typescript
// lib/monitoring/business-metrics.ts
export class BusinessMetrics {
  async getTradingMetrics() {
    const result = await query(`
      SELECT 
        COUNT(*) as total_trades,
        SUM(CASE WHEN trade_type = 'BUY' THEN 1 ELSE 0 END) as buy_trades,
        SUM(CASE WHEN trade_type = 'SELL' THEN 1 ELSE 0 END) as sell_trades,
        AVG(total_amount) as avg_trade_amount,
        SUM(total_amount) as total_volume
      FROM trade_history 
      WHERE timestamp >= NOW() - INTERVAL '24 hours'
    `)
    
    return result.rows[0]
  }
  
  async getDCAMetrics() {
    const result = await query(`
      SELECT 
        COUNT(*) as active_dca,
        SUM(current_order) as total_orders,
        SUM(total_invested) as total_invested,
        AVG(amount) as avg_order_amount
      FROM dca_settings 
      WHERE is_active = true
    `)
    
    return result.rows[0]
  }
  
  async getProfitMetrics() {
    const result = await query(`
      SELECT 
        SUM(CASE WHEN exit_price > entry_price THEN 
          (exit_price - entry_price) * quantity 
        ELSE 0 END) as total_profit,
        SUM(CASE WHEN exit_price < entry_price THEN 
          (entry_price - exit_price) * quantity 
        ELSE 0 END) as total_loss,
        COUNT(*) as closed_positions
      FROM positions 
      WHERE status = 'CLOSED'
    `)
    
    return result.rows[0]
  }
}

export const businessMetrics = new BusinessMetrics()
```

### é˜¶æ®µ3: å®‰å…¨åŠ å›º (3-4å¤©)

#### 3.1 APIå®‰å…¨åŠ å›º
```typescript
// lib/security/api-security.ts
import rateLimit from 'express-rate-limit'
import helmet from 'helmet'
import cors from 'cors'

export const securityMiddleware = [
  // åŸºç¡€å®‰å…¨å¤´
  helmet({
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        styleSrc: ["'self'", "'unsafe-inline'"],
        scriptSrc: ["'self'"],
        imgSrc: ["'self'", "data:", "https:"],
      },
    },
  }),
  
  // CORSé…ç½®
  cors({
    origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'],
    credentials: true,
  }),
  
  // é€Ÿç‡é™åˆ¶
  rateLimit({
    windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
    max: 100, // é™åˆ¶æ¯ä¸ªIP 15åˆ†é’Ÿå†…æœ€å¤š100ä¸ªè¯·æ±‚
    message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•',
  }),
]

// APIå¯†é’¥éªŒè¯ä¸­é—´ä»¶
export function validateApiKey(req: any, res: any, next: any) {
  const apiKey = req.headers['x-api-key']
  
  if (!apiKey || apiKey !== process.env.API_KEY) {
    return res.status(401).json({ error: 'æ— æ•ˆçš„APIå¯†é’¥' })
  }
  
  next()
}

// è¯·æ±‚ç­¾åéªŒè¯
export function validateSignature(req: any, res: any, next: any) {
  const signature = req.headers['x-signature']
  const timestamp = req.headers['x-timestamp']
  const body = JSON.stringify(req.body)
  
  const expectedSignature = crypto
    .createHmac('sha256', process.env.SIGNATURE_SECRET!)
    .update(`${timestamp}${body}`)
    .digest('hex')
  
  if (signature !== expectedSignature) {
    return res.status(401).json({ error: 'ç­¾åéªŒè¯å¤±è´¥' })
  }
  
  next()
}
```

#### 3.2 æ•°æ®åŠ å¯†
```typescript
// lib/security/encryption.ts
import crypto from 'crypto'

export class Encryption {
  private algorithm = 'aes-256-gcm'
  private key = Buffer.from(process.env.ENCRYPTION_KEY!, 'hex')
  
  encrypt(text: string): { encrypted: string; iv: string; authTag: string } {
    const iv = crypto.randomBytes(16)
    const cipher = crypto.createCipher(this.algorithm, this.key, iv)
    
    let encrypted = cipher.update(text, 'utf8', 'hex')
    encrypted += cipher.final('hex')
    
    return {
      encrypted,
      iv: iv.toString('hex'),
      authTag: cipher.getAuthTag().toString('hex')
    }
  }
  
  decrypt(encrypted: string, iv: string, authTag: string): string {
    const decipher = crypto.createDecipher(
      this.algorithm, 
      this.key, 
      Buffer.from(iv, 'hex')
    )
    
    decipher.setAuthTag(Buffer.from(authTag, 'hex'))
    
    let decrypted = decipher.update(encrypted, 'hex', 'utf8')
    decrypted += decipher.final('utf8')
    
    return decrypted
  }
  
  hashPassword(password: string): string {
    return crypto.pbkdf2Sync(
      password,
      process.env.PASSWORD_SALT!,
      10000,
      64,
      'sha512'
    ).toString('hex')
  }
  
  verifyPassword(password: string, hash: string): boolean {
    const passwordHash = this.hashPassword(password)
    return crypto.timingSafeEqual(
      Buffer.from(passwordHash, 'hex'),
      Buffer.from(hash, 'hex')
    )
  }
}

export const encryption = new Encryption()
```

#### 3.3 è®¿é—®æ§åˆ¶
```typescript
// lib/security/access-control.ts
export class AccessControl {
  private roles = {
    ADMIN: ['read', 'write', 'delete', 'admin'],
    USER: ['read', 'write'],
    GUEST: ['read']
  }
  
  checkPermission(userRole: string, action: string): boolean {
    const userPermissions = this.roles[userRole as keyof typeof this.roles]
    return userPermissions?.includes(action) || false
  }
  
  requirePermission(action: string) {
    return (req: any, res: any, next: any) => {
      const userRole = req.user?.role || 'GUEST'
      
      if (!this.checkPermission(userRole, action)) {
        return res.status(403).json({ error: 'æƒé™ä¸è¶³' })
      }
      
      next()
    }
  }
  
  requireRole(role: string) {
    return (req: any, res: any, next: any) => {
      const userRole = req.user?.role || 'GUEST'
      
      if (userRole !== role) {
        return res.status(403).json({ error: 'éœ€è¦ç‰¹å®šè§’è‰²æƒé™' })
      }
      
      next()
    }
  }
}

export const accessControl = new AccessControl()
```

## ğŸ“Š é¢„æœŸæ•ˆæœ

### éƒ¨ç½²æ•ˆç‡æå‡
- **éƒ¨ç½²æ—¶é—´**: ä»30åˆ†é’Ÿå‡å°‘åˆ°5åˆ†é’Ÿ
- **éƒ¨ç½²æˆåŠŸç‡**: ä»90%æå‡åˆ°99%
- **å›æ»šæ—¶é—´**: ä»10åˆ†é’Ÿå‡å°‘åˆ°2åˆ†é’Ÿ
- **ç¯å¢ƒä¸€è‡´æ€§**: 100%ä¿è¯

### ç›‘æ§èƒ½åŠ›å¢å¼º
- **é—®é¢˜å‘ç°æ—¶é—´**: ä»å°æ—¶çº§å‡å°‘åˆ°åˆ†é’Ÿçº§
- **æ€§èƒ½ç“¶é¢ˆè¯†åˆ«**: å®æ—¶ç›‘æ§å’Œå‘Šè­¦
- **ä¸šåŠ¡æŒ‡æ ‡å¯è§†åŒ–**: å®Œæ•´çš„ä»ªè¡¨æ¿
- **æ•…éšœé¢„è­¦**: æå‰å‘ç°æ½œåœ¨é—®é¢˜

### å®‰å…¨æ€§æå‡
- **APIæ”»å‡»é˜²æŠ¤**: å¤šå±‚å®‰å…¨é˜²æŠ¤
- **æ•°æ®æ³„éœ²é£é™©**: æ˜¾è‘—é™ä½
- **è®¿é—®æ§åˆ¶**: ç»†ç²’åº¦æƒé™ç®¡ç†
- **å®¡è®¡èƒ½åŠ›**: å®Œæ•´çš„æ“ä½œæ—¥å¿—

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. ç›‘æ§ä»ªè¡¨æ¿
```typescript
// pages/admin/monitoring.tsx
export default function MonitoringDashboard() {
  const [metrics, setMetrics] = useState<any>(null)
  
  useEffect(() => {
    const fetchMetrics = async () => {
      const response = await fetch('/api/admin/metrics')
      const data = await response.json()
      setMetrics(data)
    }
    
    fetchMetrics()
    const interval = setInterval(fetchMetrics, 30000) // 30ç§’æ›´æ–°
    
    return () => clearInterval(interval)
  }, [])
  
  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
      <MetricCard
        title="ç³»ç»Ÿæ€§èƒ½"
        value={metrics?.system?.cpu || 0}
        unit="%"
        trend="up"
      />
      <MetricCard
        title="æ•°æ®åº“è¿æ¥"
        value={metrics?.database?.activeConnections || 0}
        unit="ä¸ª"
        trend="stable"
      />
      <MetricCard
        title="APIå“åº”æ—¶é—´"
        value={metrics?.api?.avgResponseTime || 0}
        unit="ms"
        trend="down"
      />
    </div>
  )
}
```

### 2. å‘Šè­¦ç³»ç»Ÿ
```typescript
// lib/alerting/alert-manager.ts
export class AlertManager {
  private alerts: Alert[] = []
  
  async sendAlert(alert: Alert) {
    // å‘é€åˆ°Slack
    if (process.env.SLACK_WEBHOOK_URL) {
      await this.sendToSlack(alert)
    }
    
    // å‘é€é‚®ä»¶
    if (process.env.EMAIL_SMTP_HOST) {
      await this.sendEmail(alert)
    }
    
    // å‘é€çŸ­ä¿¡
    if (process.env.SMS_API_KEY) {
      await this.sendSMS(alert)
    }
    
    this.alerts.push(alert)
  }
  
  private async sendToSlack(alert: Alert) {
    const message = {
      text: `ğŸš¨ ${alert.level} å‘Šè­¦: ${alert.message}`,
      attachments: [{
        fields: [
          { title: 'æ—¶é—´', value: alert.timestamp },
          { title: 'æœåŠ¡', value: alert.service },
          { title: 'å»ºè®®', value: alert.recommendation }
        ]
      }]
    }
    
    await fetch(process.env.SLACK_WEBHOOK_URL!, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(message)
    })
  }
}

export const alertManager = new AlertManager()
```

## ğŸ“ˆ ç›‘æ§å’Œè¯„ä¼°

### 1. æ€§èƒ½æŒ‡æ ‡
- ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡
- åº”ç”¨å“åº”æ—¶é—´
- æ•°æ®åº“æ€§èƒ½
- é”™è¯¯ç‡ç»Ÿè®¡

### 2. ä¸šåŠ¡æŒ‡æ ‡
- äº¤æ˜“æˆåŠŸç‡
- ç”¨æˆ·æ´»è·ƒåº¦
- åŠŸèƒ½ä½¿ç”¨ç‡
- æ”¶ç›Šè¡¨ç°

### 3. å®‰å…¨æŒ‡æ ‡
- å®‰å…¨äº‹ä»¶æ•°é‡
- æ”»å‡»å°è¯•æ¬¡æ•°
- æ•°æ®æ³„éœ²é£é™©
- åˆè§„æ€§æ£€æŸ¥

## ğŸš€ å®æ–½æ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|------|----------|--------|
| 1 | éƒ¨ç½²è‡ªåŠ¨åŒ– | 3-4å¤© | ä¸­ |
| 2 | æ€§èƒ½ç›‘æ§ | 4-5å¤© | é«˜ |
| 3 | å®‰å…¨åŠ å›º | 3-4å¤© | é«˜ |
| 4 | æµ‹è¯•å’Œè°ƒä¼˜ | 2å¤© | é«˜ |

**æ€»è®¡**: 12-15å¤©

## ğŸ’¡ é£é™©æ§åˆ¶

### 1. æŠ€æœ¯é£é™©
- **éƒ¨ç½²å¤±è´¥**: å®Œå–„çš„å›æ»šæœºåˆ¶
- **ç›‘æ§è¯¯æŠ¥**: æ™ºèƒ½å‘Šè­¦è§„åˆ™
- **æ€§èƒ½å½±å“**: ç›‘æ§ç³»ç»Ÿæœ¬èº«ä¼˜åŒ–

### 2. å®‰å…¨é£é™©
- **å¯†é’¥æ³„éœ²**: å®‰å…¨çš„å¯†é’¥ç®¡ç†
- **æƒé™è¿‡åº¦**: æœ€å°æƒé™åŸåˆ™
- **å®¡è®¡é—æ¼**: å®Œæ•´çš„æ—¥å¿—è®°å½•

## ğŸ“ æ€»ç»“

é€šè¿‡å®æ–½è¿™ä¸ªéƒ¨ç½²è¿ç»´ä¼˜åŒ–è®¡åˆ’ï¼Œé¢„æœŸèƒ½å¤Ÿï¼š
1. æ˜¾è‘—æå‡éƒ¨ç½²æ•ˆç‡å’Œç¨³å®šæ€§
2. å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»
3. å¢å¼ºç³»ç»Ÿå®‰å…¨æ€§å’Œåˆè§„æ€§
4. æä¾›æ›´å¥½çš„è¿ç»´ä½“éªŒ

å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥å®æ–½ï¼Œç¡®ä¿æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ˜ç¡®çš„æˆæœå’ŒéªŒè¯ã€‚ 