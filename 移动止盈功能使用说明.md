# 移动止盈功能使用说明

## 📋 功能概述

移动止盈（Trailing Stop）是一种动态风险管理策略，能够自动调整止盈价格以保护已获得的利润。当价格向有利方向移动时，移动止盈价格会跟随调整，当价格回撤到移动止盈价格时自动平仓。

## 🎯 工作原理

### 做多持仓
- **初始设置**: 当启用移动止盈时，系统会记录当前价格作为初始最高价格
- **价格上升**: 当价格超过之前的最高价格时，移动止盈价格会自动上调
- **价格回撤**: 当价格下跌到移动止盈价格时，自动触发平仓
- **计算公式**: 移动止盈价格 = 最高价格 × (1 - 距离百分比)

### 做空持仓
- **初始设置**: 当启用移动止盈时，系统会记录当前价格作为初始最低价格
- **价格下跌**: 当价格低于之前的最低价格时，移动止盈价格会自动下调
- **价格反弹**: 当价格上涨到移动止盈价格时，自动触发平仓
- **计算公式**: 移动止盈价格 = 最低价格 × (1 + 距离百分比)

## 🚀 使用方法

### 1. 启用移动止盈
1. 在持仓管理页面找到需要设置移动止盈的活跃持仓
2. 点击"设置移动止盈"按钮
3. 在弹出的模态框中勾选"启用移动止盈"
4. 设置移动止盈距离（建议3-10%）
5. 点击"保存设置"

### 2. 查看移动止盈状态
- 启用移动止盈的持仓会显示绿色的"移动止盈"按钮
- 在持仓信息中可以看到：
  - 当前移动止盈价格
  - 移动止盈距离百分比
  - 持仓期间最高/最低价格

### 3. 禁用移动止盈
1. 点击持仓的"移动止盈"按钮
2. 在模态框中取消勾选"启用移动止盈"
3. 点击"禁用移动止盈"

## ⚙️ 参数设置建议

### 移动止盈距离
- **保守策略**: 3-5% - 适合波动较小的市场
- **平衡策略**: 5-8% - 适合一般市场条件
- **激进策略**: 8-15% - 适合波动较大的市场

### 不同持仓类型的建议
- **做多持仓**: 建议设置5-10%的距离
- **做空持仓**: 建议设置5-10%的距离
- **短线交易**: 可以设置较小的距离（3-5%）
- **长线持仓**: 可以设置较大的距离（8-15%）

## 🔄 自动检查机制

系统会定期检查所有启用移动止盈的持仓：

1. **价格监控**: 实时监控当前价格变化
2. **最高/最低价格更新**: 自动更新持仓期间的最高/最低价格
3. **移动止盈价格调整**: 根据新的最高/最低价格自动调整移动止盈价格
4. **平仓触发**: 当价格触及移动止盈价格时自动平仓

## 📊 界面显示

### 持仓列表中的显示
- **移动止盈按钮**: 显示当前状态（启用/未启用）
- **移动止盈信息**: 显示当前移动止盈价格和距离
- **价格追踪**: 显示持仓期间的最高/最低价格

### 状态指示
- 🟢 **绿色按钮**: 移动止盈已启用
- 🔵 **蓝色按钮**: 移动止盈未启用
- 📈 **价格信息**: 实时显示移动止盈价格和追踪价格

## ⚠️ 注意事项

### 风险提示
1. **市场波动**: 在剧烈波动的市场中，移动止盈可能过早触发
2. **滑点风险**: 实际平仓价格可能与移动止盈价格有差异
3. **技术故障**: 系统故障可能导致移动止盈失效

### 使用建议
1. **合理设置距离**: 根据市场波动性和持仓周期设置合适的距离
2. **定期检查**: 定期检查移动止盈设置是否正确
3. **结合其他策略**: 可以将移动止盈与其他风险管理策略结合使用
4. **测试验证**: 在实盘使用前，建议先进行模拟测试

## 🔧 技术实现

### 数据库字段
- `trailing_stop_enabled`: 是否启用移动止盈
- `trailing_stop_distance`: 移动止盈距离（百分比）
- `trailing_stop_price`: 当前移动止盈价格
- `highest_price`: 持仓期间最高价格
- `lowest_price`: 持仓期间最低价格

### API接口
- `PUT /api/positions/[id]/trailing-stop`: 设置移动止盈
- `GET /api/positions/[id]/trailing-stop`: 获取移动止盈状态
- `GET /api/cron/trailing-stop-check`: 移动止盈检查定时任务

## 📈 使用示例

### 示例1: 做多持仓移动止盈
```
入场价格: $170.00
移动止盈距离: 5%
初始移动止盈价格: $161.50 (170 × 0.95)

价格上升到 $180.00:
- 最高价格更新为 $180.00
- 移动止盈价格更新为 $171.00 (180 × 0.95)

价格继续上升到 $190.00:
- 最高价格更新为 $190.00
- 移动止盈价格更新为 $180.50 (190 × 0.95)

价格回撤到 $180.50:
- 触发移动止盈，自动平仓
- 保护了 $10.50 的利润
```

### 示例2: 做空持仓移动止盈
```
入场价格: $180.00
移动止盈距离: 5%
初始移动止盈价格: $189.00 (180 × 1.05)

价格下跌到 $170.00:
- 最低价格更新为 $170.00
- 移动止盈价格更新为 $178.50 (170 × 1.05)

价格继续下跌到 $160.00:
- 最低价格更新为 $160.00
- 移动止盈价格更新为 $168.00 (160 × 1.05)

价格反弹到 $168.00:
- 触发移动止盈，自动平仓
- 保护了 $12.00 的利润
```

## 🎉 总结

移动止盈功能是一个强大的风险管理工具，能够：
- 自动保护已获得的利润
- 减少人为情绪干扰
- 提高交易纪律性
- 优化风险收益比

通过合理设置移动止盈参数，可以有效提升交易策略的整体表现。 