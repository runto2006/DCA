# DCA自动交易使用说明

## 🚀 功能概述

DCA（Dollar Cost Averaging）自动交易系统基于30分钟图表和EMA89线进行智能交易。当价格跌破EMA89线时，系统会自动执行买入操作，实现分批建仓的策略。

## ⚠️ 重要风险提示

**这是真实交易功能，将使用您的币安账户进行实际交易，请务必谨慎操作！**

- 所有交易都是真实的，会实际影响您的账户余额
- 加密货币市场波动剧烈，存在亏损风险
- 请确保您了解DCA策略的风险和收益
- 建议先使用小额资金测试交易功能

## 🔧 系统要求

### 1. 币安API配置
- 有效的币安API密钥
- API具有交易权限
- IP白名单设置（推荐）

### 2. 环境变量配置
在 `.env.local` 文件中添加：
```env
# 币安API配置
BINANCE_API_KEY=your_binance_api_key
BINANCE_API_SECRET=your_binance_api_secret

# Supabase配置
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_key
```

## 📊 交易策略说明

### 核心逻辑
1. **触发条件**: 30分钟图表中价格跌破EMA89线
2. **交易方向**: 仅执行买入操作（分批建仓）
3. **订单递增**: 每次订单金额按1.5倍递增
4. **最大订单**: 默认最多执行6次买入订单

### 订单金额计算
- 第1单: 80 USDT
- 第2单: 120 USDT (80 × 1.5)
- 第3单: 180 USDT (120 × 1.5)
- 第4单: 270 USDT (180 × 1.5)
- 第5单: 405 USDT (270 × 1.5)
- 第6单: 607.5 USDT (405 × 1.5)

**总投入**: 约1,662.5 USDT

## 🎯 使用步骤

### 1. 启动系统
```bash
npm run dev
```

### 2. 访问DCA交易面板
在系统主页面的"DCA自动交易"区域：
- 查看当前市场状态
- 配置交易参数
- 启动/停止自动交易

### 3. 配置交易参数
点击设置按钮，配置以下参数：
- **交易对**: SOL/USDT 或 BTC/USDT
- **基础订单金额**: 首单金额（默认80 USDT）
- **最大订单数**: 最多执行次数（默认6次）
- **止盈百分比**: 单笔订单止盈比例（默认1.2%）
- **止损百分比**: 整体止损比例（默认5.0%）
- **价格偏差**: 价格偏差容忍度（默认1.5%）

### 4. 启动DCA交易
1. 确认参数设置正确
2. 点击"启动DCA交易"按钮
3. 系统开始监控市场条件

### 5. 监控交易状态
- 实时查看30分钟图表和EMA89分析
- 监控DCA交易进度
- 查看交易历史记录

## 🔄 自动执行机制

### 定时检查
- 系统每30分钟自动检查一次交易条件
- 通过 `/api/cron/dca-check` 接口执行
- 可以设置外部定时任务调用此接口

### 手动执行
- 在Web界面点击"手动执行"按钮
- 立即检查当前市场条件
- 如果满足条件则执行交易

### 执行条件
1. DCA交易已启动（is_active = true）
2. 未达到最大订单数
3. 价格跌破EMA89线
4. 账户有足够USDT余额

## 📈 市场分析

### 30分钟图表分析
- **当前价格**: 实时价格
- **EMA89**: 89周期指数移动平均线
- **价格距离**: 当前价格与EMA89的距离百分比
- **交易条件**: 是否满足买入条件

### 技术指标说明
- **EMA89**: 长期趋势指标，价格跌破表示可能进入下跌趋势
- **30分钟周期**: 中等时间框架，平衡短期噪音和长期趋势
- **分批建仓**: 降低单次买入风险，平均成本

## 🛡️ 风险控制

### 内置安全机制
1. **余额检查**: 每次交易前检查USDT余额
2. **权限验证**: 验证API交易权限
3. **参数验证**: 验证交易参数合理性
4. **错误处理**: 完善的错误处理和日志记录

### 用户安全建议
1. **小额测试**: 先用小额资金测试系统
2. **监控余额**: 定期检查账户余额
3. **设置止损**: 合理设置止损比例
4. **定期检查**: 定期检查交易记录和系统状态

## 📊 数据存储

### 数据库表结构
- **dca_settings**: DCA交易设置
- **trade_history**: 交易历史记录
- **user_positions**: 用户持仓信息

### 关键字段说明
```sql
-- DCA设置表
CREATE TABLE dca_settings (
    symbol VARCHAR(20),           -- 交易对
    is_active BOOLEAN,            -- 是否激活
    amount DECIMAL(20, 8),        -- 基础订单金额
    max_orders INTEGER,           -- 最大订单数
    current_order INTEGER,        -- 当前订单数
    total_invested DECIMAL(20, 8), -- 总投入金额
    last_check TIMESTAMP          -- 最后检查时间
);
```

## 🔧 故障排除

### 常见问题

**1. "账户没有交易权限"**
- 检查API密钥配置
- 确认API具有交易权限
- 验证IP地址在白名单中

**2. "USDT余额不足"**
- 检查账户USDT余额
- 考虑交易手续费
- 调整基础订单金额

**3. "价格未跌破EMA89"**
- 这是正常情况，系统会等待合适时机
- 可以手动检查当前市场状态
- 考虑调整策略参数

**4. "已达到最大订单数"**
- DCA交易已完成
- 可以重新启动新的DCA策略
- 检查总投入和持仓情况

### 日志查看
- 控制台日志: 查看API执行日志
- 数据库日志: 查看交易记录
- 错误日志: 查看错误详情

## 📞 技术支持

### 测试脚本
运行测试脚本验证功能：
```bash
node test-dca-auto-trade.js
```

### API接口
- `GET /api/dca-auto-trade`: 获取DCA状态
- `POST /api/dca-auto-trade`: 执行DCA操作
- `GET /api/cron/dca-check`: 定时检查接口

### 监控建议
1. 定期检查系统运行状态
2. 监控交易执行情况
3. 关注市场变化和策略表现
4. 及时调整参数设置

## 📝 更新日志

### v1.0.0 (2025-01-18)
- ✅ 实现基于EMA89的DCA自动交易
- ✅ 支持30分钟图表分析
- ✅ 订单金额递增机制
- ✅ 完整的风险控制
- ✅ Web界面管理
- ✅ 定时任务支持

---

**注意**: 本系统仅供学习和研究使用，不构成投资建议。请根据自身风险承受能力谨慎使用。 